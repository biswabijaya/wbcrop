<!DOCTYPE html>

<html lang="en">

<head>
    <title>ImageCropper</title>
    <meta charset="UTF-8" />
    <meta name="author" content="Biswabijaya Samal">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <!-- Canonical Tags to link similar mobile and desktop sites -->
    <link rel="canonical" href="http://example.com/">

    <link rel="stylesheet" href="assets/css/ripple.css">
    <link rel="stylesheet" href="assets/css/normalize.css">
    <link rel="stylesheet" href="assets/css/animate.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="assets/css/wbcrop.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="assets/js/ripple.js" defer></script>

    <!-- Font Link -->
    <link href="https://fonts.googleapis.com/css?family=Basic" rel="stylesheet">

    <script defer>
        $(document).ready(function(){
            //
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            var img = new Image();
            //
            var windowHeight = $(window).outerHeight();
            $('body').css("height", windowHeight);
            //
            var wbcropTargetDisplay = $('*[data-wbcrop=""]');
            //
            var wbcropModalDisplay = $('.wbcrop-modal-display');
            //
            var wbcropOutline = document.getElementById('wbcrop-cropper-outline');
            // get left, top, right, bottom, x, y, width, height of wbcrop-cropper-outline
            var wbcropOutlineDimensions = wbcropOutline.getBoundingClientRect();
            // get position of wbcrop-cropper-outline
            var wbcropOutlinePosition = $(wbcropOutline).position();
            //
            $('#wbcrop-modal-cover').hide();
            //
            var wbcropDisplayContainer = document.getElementById('wbcrop-modal-display-container');
            var wbcropDisplayContainerHeight = $(wbcropDisplayContainer).innerHeight();
            var wbcropDisplayContainerWidth = $(wbcropDisplayContainer).innerWidth();
            // get left, top, right, bottom, x, y, width, height of wbcrop-modal-display-container
            var wbcropDisplayContainerDimensions = wbcropDisplayContainer.getBoundingClientRect();
            //
            canvas.width = wbcropDisplayContainerWidth;
            canvas.height = wbcropDisplayContainerHeight;
            //
            function readURL(input, targetDisplay) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function(e) {
                        $(input).siblings(wbcropTargetDisplay).css("background-image", "url(" + e.target.result + ")");
                        openModal(e.target.result);

                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }
            //
            function changeRotateAngle(angle) {
                angle = angle - 90;
                //
                $(wbcropModalDisplay).css("transform", "rotate(" + angle + "deg)");
                $(wbcropModalDisplay).children().css("transform", "rotate(" + angle + "deg)");
                wbcropOutlineRotateOffset(angle);
                return angle;
            }
            //
            function wbcropOutlineRotateOffset(angle) {
                angle = Math.abs(angle);
                // get left, top, right, bottom, x, y, width, height of wbcrop-cropper-outline
                var wbcropOutlineDimensions = wbcropOutline.getBoundingClientRect();
                // get position of wbcrop-cropper-outline
                var wbcropOutlinePosition = $(wbcropOutline).position();
                // get left, top, right, bottom, x, y, width, height of wbcrop-cropper-outline
                var wbcropOutlineDimensions = wbcropOutline.getBoundingClientRect();
                // get wbcrop-modal-display-container height and width
                var wbcropDisplayContainerHeight = $(wbcropDisplayContainer).innerHeight();
                var wbcropDisplayContainerWidth = $(wbcropDisplayContainer).innerWidth();
                //
                var rotationAngle = getRotateValue(document.getElementById('wbcrop-modal-display'));
                // clip
                switch(rotationAngle) {
                    case -90:
                        $('#wbcrop-modal-display2').css('clip', "rect(" + wbcropOutlinePosition.left + "px," + (wbcropDisplayContainerHeight - wbcropOutlinePosition.top) + "px," + (wbcropOutlinePosition.left + wbcropOutlineDimensions.width) + "px," + (wbcropDisplayContainerHeight - (wbcropOutlinePosition.top + wbcropOutlineDimensions.height)) + "px)");
                            break;
                    case -180:
                        $('#wbcrop-modal-display2').css('clip', "rect(" + (wbcropDisplayContainerHeight - (wbcropOutlinePosition.top + wbcropOutlineDimensions.height)) + "px," + (wbcropDisplayContainerWidth - wbcropOutlinePosition.left) + "px," + (wbcropDisplayContainerHeight - wbcropOutlinePosition.top) + "px," + (wbcropDisplayContainerWidth - (wbcropOutlineDimensions.width + wbcropOutlinePosition.left)) + "px)");
                            break;
                    case 90:
                        $('#wbcrop-modal-display2').css('clip', "rect(" + (wbcropDisplayContainerWidth - (wbcropOutlinePosition.left + wbcropOutlineDimensions.width)) + "px," + (wbcropOutlinePosition.top + wbcropOutlineDimensions.height) + "px," + (wbcropDisplayContainerWidth - wbcropOutlinePosition.left) + "px," + wbcropOutlinePosition.top + "px)");
                            break;
                    default:
                        $('#wbcrop-modal-display2').css('clip', "rect(" + wbcropOutlinePosition.top + "px," + (wbcropOutlineDimensions.width + wbcropOutlinePosition.left) + "px," + (wbcropOutlineDimensions.height + wbcropOutlinePosition.top) + "px," + wbcropOutlinePosition.left + "px)");
                }

            }
            //
            function getRotateValue (element) {
                var st = window.getComputedStyle(element, null);
                var tr = st.getPropertyValue("-webkit-transform") ||
                         st.getPropertyValue("-moz-transform") ||
                         st.getPropertyValue("-ms-transform") ||
                         st.getPropertyValue("-o-transform") ||
                         st.getPropertyValue("transform") ||
                         "FAIL";

                // With rotate(30deg)...
                // matrix(0.866025, 0.5, -0.5, 0.866025, 0px, 0px)
                console.log('Matrix: ' + tr);

                // rotation matrix - http://en.wikipedia.org/wiki/Rotation_matrix

                var values = tr.split('(')[1].split(')')[0].split(',');
                var a = values[0];
                var b = values[1];
                var c = values[2];
                var d = values[3];

                var scale = Math.sqrt(a*a + b*b);

                console.log('Scale: ' + scale);

                // arc sin, convert from radians to degrees, round
                var sin = b/scale;
                // next line works for 30deg but not 130deg (returns 50);
                // var angle = Math.round(Math.asin(sin) * (180/Math.PI));
                var angle = Math.round(Math.atan2(b, a) * (180/Math.PI));

                console.log('Rotate: ' + angle + 'deg');
                //
                return angle;
            }
            //
            function openModal(imageUrl) {
                //
                $('#wbcrop-rotate-button').click(function(){
                    //
                    changeRotateAngle(getRotateValue(document.getElementById('wbcrop-modal-display')));
                    //
                    var rotationAngle = getRotateValue(document.getElementById('wbcrop-modal-display'));
                    drawRotated(rotationAngle);
                    // contextRotate();
                });
                //
                $('#wbcrop-crop-button').click(function(){
                    var wbcropOutline = document.getElementById('wbcrop-cropper-outline');
                    // get left, top, right, bottom, x, y, width, height of wbcrop-cropper-outline
                    var wbcropOutlineDimensions = wbcropOutline.getBoundingClientRect();
                    // get position of wbcrop-cropper-outline
                    var wbcropOutlinePosition = $(wbcropOutline).position();
                    //
                    var rotationAngle = getRotateValue(document.getElementById('wbcrop-modal-display'));
                    // clip
                    switch(rotationAngle) {
                        case -90:
                            var imageData = ctx.getImageData((wbcropDisplayContainerHeight - (wbcropOutlinePosition.top + wbcropOutlineDimensions.height)), wbcropOutlinePosition.left, wbcropOutlineDimensions.height, wbcropOutlineDimensions.width);
                            drawNewImage(imageData);
                            break;
                        case -180:
                            var imageData = ctx.getImageData(wbcropOutlinePosition.left, wbcropOutlinePosition.top, wbcropOutlineDimensions.width, wbcropOutlineDimensions.height);
                            drawNewImage(imageData);
                            break;
                        case 90:
                            var imageData = ctx.getImageData(wbcropOutlinePosition.left, wbcropOutlinePosition.top, wbcropOutlineDimensions.width, wbcropOutlineDimensions.height);
                            drawNewImage(imageData);
                            break;
                        default:
                            var imageData = ctx.getImageData(wbcropOutlinePosition.left, wbcropOutlinePosition.top, wbcropOutlineDimensions.width, wbcropOutlineDimensions.height);
                            drawNewImage(imageData);
                    }
                    //
                });
                //
                function drawRotated(degrees){
                    //
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    // save the unrotated context of the canvas so we can restore it later
                    // the alternative is to untranslate & unrotate after drawing
                    ctx.save();
                    // move to the center of the canvas
                    ctx.translate(canvas.width/2,canvas.height/2);
                    // rotate the canvas to the specified degrees
                    ctx.rotate(degrees*Math.PI/180);
                    // draw the image
                    // since the context is rotated, the image will be rotated also
                    ctx.translate(-canvas.width / 2, -canvas.height / 2);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    // we’re done with the rotating so restore the unrotated context
                    ctx.restore();
                }
                //
                var rotation = -90;
                function contextRotate() {
                   ctx.clearRect(0, 0, canvas.width, canvas.height);
                   ctx.save(); //save canvas state
                   ctx.translate(canvas.width / 2, canvas.height / 2);
                   ctx.rotate(rotation * Math.PI / 180);
                   ctx.translate(-canvas.width / 2, -canvas.height / 2);
                   ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                   rotation -= 90;
                   ctx.restore(); //restore canvas state
                }
                //
                $('#wbcrop-modal-cover').show("medium", function() {
                    // Animation complete.. now perform other tasks
                    // Get the crop-outline box, make it draggable and resizeable to its parent (the display)
                    var wbcropOutline = document.getElementById('wbcrop-cropper-outline');
                    $(wbcropOutline).draggable({
                        containment: "parent",
                        drag: wbcropOutlineDraging,
                        stop: wbcropOutlineDraging,
                    }).resizable({
                        handles: {
                            'nw': '#nw-outline-handle',
                            'ne': '#ne-outline-handle',
                            'sw': '#sw-outline-handle',
                            'se': '#se-outline-handle',
                            'n': '#n-outline-handle',
                            'e': '#e-outline-handle',
                            's': '#s-outline-handle',
                            'w': '#w-outline-handle',
                        },
                        containment: "parent",
                        resize: wbcropOutlineResizing,
                        stop: wbcropOutlineResizing,
                    });
                    // Get position (left and top coordinates) of crop-outline box with respect to its parent
                    var wbcropOutlinePosition = $(wbcropOutline).position();
                    //
                    // run functions
                    function wbcropOutlineResizing(e, ui) {
                        // get position of wbcrop-cropper-outline
                        var wbcropOutlinePosition = $(wbcropOutline).position();
                        // get width and height
                        var width = ui.size.width,
                        height = ui.size.height;
                        //
                        var wbcropOutlineDimensions = wbcropOutline.getBoundingClientRect();
                        // get wbcrop-modal-display-container height and width
                        var wbcropDisplayContainerHeight = $(wbcropDisplayContainer).innerHeight();
                        var wbcropDisplayContainerWidth = $(wbcropDisplayContainer).innerWidth();
                        //
                        var rotationAngle = getRotateValue(document.getElementById('wbcrop-modal-display'));
                        // clip
                        switch(rotationAngle) {
                          case -90:
                            $('#wbcrop-modal-display2').css('clip', "rect(" + wbcropOutlinePosition.left + "px," + (wbcropDisplayContainerHeight - wbcropOutlinePosition.top) + "px," + (wbcropOutlinePosition.left + wbcropOutlineDimensions.width) + "px," + (wbcropDisplayContainerHeight - (wbcropOutlinePosition.top + wbcropOutlineDimensions.height)) + "px)");
                            break;
                          case -180:
                            $('#wbcrop-modal-display2').css('clip', "rect(" + (wbcropDisplayContainerHeight - (wbcropOutlinePosition.top + wbcropOutlineDimensions.height)) + "px," + (wbcropDisplayContainerWidth - wbcropOutlinePosition.left) + "px," + (wbcropDisplayContainerHeight - wbcropOutlinePosition.top) + "px," + (wbcropDisplayContainerWidth - (wbcropOutlineDimensions.width + wbcropOutlinePosition.left)) + "px)");
                            break;
                          case 90:
                            $('#wbcrop-modal-display2').css('clip', "rect(" + (wbcropDisplayContainerWidth - (wbcropOutlinePosition.left + wbcropOutlineDimensions.width)) + "px," + (wbcropOutlinePosition.top + wbcropOutlineDimensions.height) + "px," + (wbcropDisplayContainerWidth - wbcropOutlinePosition.left) + "px," + wbcropOutlinePosition.top + "px)");
                            break;
                          default:
                            $('#wbcrop-modal-display2').css('clip', "rect(" + wbcropOutlinePosition.top + "px," + (wbcropOutlineDimensions.width + wbcropOutlinePosition.left) + "px," + (wbcropOutlineDimensions.height + wbcropOutlinePosition.top) + "px," + wbcropOutlinePosition.left + "px)");
                        }
                    }
                    //
                    function wbcropOutlineDraging() {
                        // get position of wbcrop-cropper-outline
                        var wbcropOutlinePosition = $(wbcropOutline).position();
                        // get left, top, right, bottom, x, y, width, height of wbcrop-cropper-outline
                        var wbcropOutlineDimensions = wbcropOutline.getBoundingClientRect();
                        // get wbcrop-modal-display-container height and width
                        var wbcropDisplayContainerHeight = $(wbcropDisplayContainer).innerHeight();
                        var wbcropDisplayContainerWidth = $(wbcropDisplayContainer).innerWidth();
                        //
                        var rotationAngle = getRotateValue(document.getElementById('wbcrop-modal-display'));
                        // clip
                        switch(rotationAngle) {
                          case -90:
                            $('#wbcrop-modal-display2').css('clip', "rect(" + wbcropOutlinePosition.left + "px," + (wbcropDisplayContainerHeight - wbcropOutlinePosition.top) + "px," + (wbcropOutlinePosition.left + wbcropOutlineDimensions.width) + "px," + (wbcropDisplayContainerHeight - (wbcropOutlinePosition.top + wbcropOutlineDimensions.height)) + "px)");
                            break;
                          case -180:
                            $('#wbcrop-modal-display2').css('clip', "rect(" + (wbcropDisplayContainerHeight - (wbcropOutlinePosition.top + wbcropOutlineDimensions.height)) + "px," + (wbcropDisplayContainerWidth - wbcropOutlinePosition.left) + "px," + (wbcropDisplayContainerHeight - wbcropOutlinePosition.top) + "px," + (wbcropDisplayContainerWidth - (wbcropOutlineDimensions.width + wbcropOutlinePosition.left)) + "px)");
                            break;
                          case 90:
                            $('#wbcrop-modal-display2').css('clip', "rect(" + (wbcropDisplayContainerWidth - (wbcropOutlinePosition.left + wbcropOutlineDimensions.width)) + "px," + (wbcropOutlinePosition.top + wbcropOutlineDimensions.height) + "px," + (wbcropDisplayContainerWidth - wbcropOutlinePosition.left) + "px," + wbcropOutlinePosition.top + "px)");
                            break;
                          default:
                            $('#wbcrop-modal-display2').css('clip', "rect(" + wbcropOutlinePosition.top + "px," + (wbcropOutlineDimensions.width + wbcropOutlinePosition.left) + "px," + (wbcropOutlineDimensions.height + wbcropOutlinePosition.top) + "px," + wbcropOutlinePosition.left + "px)");
                        }
                    }
                });

                //
                $('#wbcrop-modal-display').css("background-image", "url(" + imageUrl + ")");
                $('#wbcrop-modal-display2').css("background-image", "url(" + imageUrl + ")");
                $('#wbcrop-outline-display').css("background-image", "url(" + imageUrl + ")");
                drawimg(imageUrl);
            }

            function drawimg(idata) {
                img.onload = function(){
                    var imgWidth = img.width;
                    var imgHeight = img.height;
                    img.width = wbcropDisplayContainerWidth;
                    img.height = wbcropDisplayContainerHeight;
                    canvas.width = wbcropDisplayContainerWidth;
                    canvas.height = wbcropDisplayContainerHeight;
                    ctx.drawImage(img, 0, 0, wbcropDisplayContainerWidth, wbcropDisplayContainerHeight);
                };
                img.src = idata;
                canvas.toDataURL("image/png");
            }

            function drawNewImage(idata) {
                const wbcropCroppingCanvas = document.getElementById('wbcrop-cropping-canvas');
                const wbcropCroppingCanvasContext = wbcropCroppingCanvas.getContext('2d');
                var img1 = new Image();
                img1.width = $(wbcropOutline).outerWidth();
                img1.height = $(wbcropOutline).outerHeight();
                wbcropCroppingCanvas.width = $(wbcropOutline).outerWidth();
                wbcropCroppingCanvas.height = $(wbcropOutline).outerHeight();
                wbcropCroppingCanvasContext.putImageData(idata, 0, 0);
            }

            $("input[type=file]").change(function() {
                readURL(this, wbcropTargetDisplay);
            });


            // vars
            // let result = document.querySelector(".result"),
            //   img_result = document.querySelector(".img-result"),
            //   img_w = document.querySelector(".img-w"),
            //   img_h = document.querySelector(".img-h"),
            //   options = document.querySelector(".options"),
            //   save = document.querySelector("#wbcrop-crop-button"),
            //   cropped = document.querySelector(".cropped"),
            //   dwn = document.querySelector(".download"),
            //   upload = document.querySelector("#file-input"),
            //   cropper = "";

            // // save on click
            // save.addEventListener("click", e => {
            //     e.preventDefault();
            //     // get result to data uri


            //   // show image cropped
            //   cropped.src = imgSrc;
            //   // dwn.classList.remove("hide");
            //   // dwn.download = "imagename.png";
            //   // dwn.setAttribute("href", imgSrc);
            // });

        });
        //

    </script>

    <!-- Styles -->
    <style></style>

</head>

<body>
    <div>
        <div id="" class="image-previewer" data-wbcrop=""></div>
        <input type="file" name="">
    </div>
    <div>
        <div id="" class="image-previewer" data-wbcrop=""></div>
        <input type="file" name="">
    </div>
    <canvas id="canvas"></canvas>
    <canvas id="wbcrop-cropping-canvas"></canvas>
    <!-- The Modal -->
    <div id="wbcrop-modal-cover" class="wbcrop-modal-cover">
        <!-- Modal content -->
        <div id="wbcrop-modal" class="wbcrop-modal">
            <div id="wbcrop-close" class="wbcrop-close">&times;</div>
            <div id="wbcrop-modal-display-container" class="wbcrop-modal-display-container">
                <div id="wbcrop-modal-display" class="wbcrop-modal-display"></div>
                <div id="wbcrop-modal-cropper" class="wbcrop-modal-cropper"></div>
                <div id="wbcrop-modal-display2" class="wbcrop-modal-display" style="clip: rect(46px, 205px, 205px, 46px);"></div>
                <div id="wbcrop-cropper-outline" class="wbcrop-cropper-outline" style="left:45px; top:45px; width: 160px; height: 160px;">
                    <div class="wbcrop-outline-handle ui-resizable-handle ui-resizable-nw" id="nw-outline-handle"></div>
                    <div class="wbcrop-outline-handle ui-resizable-handle ui-resizable-ne" id="ne-outline-handle"></div>
                    <div class="wbcrop-outline-handle ui-resizable-handle ui-resizable-sw" id="sw-outline-handle"></div>
                    <div class="wbcrop-outline-handle ui-resizable-handle ui-resizable-se" id="se-outline-handle"></div>
                    <div class="wbcrop-outline-handle ui-resizable-handle ui-resizable-n" id="n-outline-handle"></div>
                    <div class="wbcrop-outline-handle ui-resizable-handle ui-resizable-s" id="s-outline-handle"></div>
                    <div class="wbcrop-outline-handle ui-resizable-handle ui-resizable-e" id="e-outline-handle"></div>
                    <div class="wbcrop-outline-handle ui-resizable-handle ui-resizable-w" id="w-outline-handle"></div>
                </div>
            </div>
            <div class="wbcrop-modal-buttons-container">
                <div id="wbcrop-rotate-button" class="wbcrop-modal-button" data-ripple="">
                    <!-- <svg class="feather">
                        <use xlink:href="assets/icons/feather/feather-sprite.svg#circle"/>
                    </svg> -->
                    <img class="wbcrop-svg" src="assets/icons/feather/rotate-ccw.svg">
                </div>
                <div id="wbcrop-crop-button" class="wbcrop-modal-button" data-ripple="">
                    <img class="wbcrop-svg" src="assets/icons/feather/crop.svg">
                </div>
            </div>
        </div>
    </div>
</body>

</html>
